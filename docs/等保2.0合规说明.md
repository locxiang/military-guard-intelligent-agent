# 等保 2.0 合规性说明文档

本文档说明本系统后端架构如何符合《网络安全等级保护基本要求》（等保 2.0）标准。

## 一、身份鉴别（安全物理环境）

### 1.1 用户身份标识

- ✅ **用户唯一标识**：系统使用 `username` 作为用户唯一标识，数据库层面使用唯一索引保证
- ✅ **用户身份验证**：所有登录操作都需要用户名和密码双重验证

### 1.2 用户身份鉴别

- ✅ **密码加密存储**：使用 `bcrypt` 算法对密码进行哈希存储（`app/core/security.py`）
- ✅ **强密码策略**：
  - 最小长度：8 个字符（可配置 `PASSWORD_MIN_LENGTH`）
  - 必须包含大写字母（`PASSWORD_REQUIRE_UPPERCASE`）
  - 必须包含小写字母（`PASSWORD_REQUIRE_LOWERCASE`）
  - 必须包含数字（`PASSWORD_REQUIRE_DIGIT`）
  - 必须包含特殊字符（`PASSWORD_REQUIRE_SPECIAL`）
- ✅ **登录失败处理**：配置了最大登录尝试次数（`MAX_LOGIN_ATTEMPTS`）和锁定时间（`LOGIN_LOCKOUT_MINUTES`）
- ✅ **会话超时**：配置了会话超时时间（`SESSION_TIMEOUT_MINUTES`）

### 1.3 身份鉴别信息管理

- ✅ **密码强度验证**：`app/utils/password.py` 提供密码强度验证工具
- ✅ **密码过期策略**：支持配置密码最大有效期（`PASSWORD_MAX_AGE_DAYS`）
- ✅ **安全存储**：敏感配置通过环境变量管理，不在代码中硬编码

## 二、访问控制

### 2.1 访问控制策略

- ✅ **基于角色的访问控制（RBAC）**：
  - 用户角色：`admin`、`user`
  - 权限检查依赖：`require_admin`、`require_user`（`app/core/security.py`）
- ✅ **最小权限原则**：接口级别的权限控制，使用 FastAPI 依赖注入

### 2.2 访问控制实现

- ✅ **JWT Token 认证**：
  - Token 包含用户身份信息（`user_id`、`username`）
  - Token 签名验证（`verify_signature`）
  - Token 过期验证（`verify_exp`）
  - Token 签发者验证（`verify_iss`）
- ✅ **权限装饰器**：`require_roles()` 工厂函数支持灵活的权限控制

## 三、安全审计

### 3.1 审计数据生成

- ✅ **审计日志表**：`AuditLog` 模型（`app/core/audit.py`）记录所有重要操作
- ✅ **审计内容**：
  - 用户身份信息（`user_id`、`username`）
  - 操作类型（`action`）：login/logout/create/update/delete/query/export
  - 资源信息（`resource_type`、`resource_id`）
  - 请求信息（`request_id`、`method`、`path`、`client_ip`、`user_agent`）
  - 操作结果（`status`、`status_code`、`error_message`）
  - 时间戳（`created_at`）

### 3.2 审计记录存储

- ✅ **持久化存储**：审计日志存储在数据库 `audit_logs` 表中
- ✅ **日志保留**：支持配置审计日志保留天数（`AUDIT_LOG_RETENTION_DAYS`）
- ✅ **应用日志**：同时使用 `loguru` 记录到应用日志文件

### 3.3 访问日志

- ✅ **访问日志中间件**：`AccessLogMiddleware`（`app/core/middleware.py`）
  - 记录所有请求的开始和结束
  - 记录请求 ID、方法、路径、客户端 IP、User Agent
  - 记录处理时间
  - 记录请求状态码

### 3.4 审计功能

- ✅ **登录审计**：`AuditLogger.log_login()` 记录所有登录尝试（成功/失败）
- ✅ **登出审计**：`AuditLogger.log_logout()` 记录用户登出
- ✅ **操作审计**：`AuditLogger.log_operation()` 记录业务操作

## 四、入侵防范

### 4.1 安全检测机制

- ✅ **速率限制**：`RateLimitMiddleware` 防止暴力破解和 DDoS 攻击
  - 可配置请求次数（`RATE_LIMIT_CALLS`）和时间窗口（`RATE_LIMIT_PERIOD`）
- ✅ **输入验证**：`InputSanitizationMiddleware` 检测 SQL 注入和 XSS 攻击
  - 检测 SQL 关键词
  - 检测可疑输入模式

### 4.2 安全防护措施

- ✅ **安全响应头**：`SecurityHeadersMiddleware` 添加安全响应头
  - `X-Content-Type-Options: nosniff` - 防止 MIME 类型嗅探
  - `X-Frame-Options: DENY` - 防止点击劫持
  - `X-XSS-Protection: 1; mode=block` - XSS 保护
  - `Strict-Transport-Security` - 强制 HTTPS（生产环境）
  - `Content-Security-Policy` - 内容安全策略
  - `Referrer-Policy` - 引用策略
  - `Permissions-Policy` - 权限策略

## 五、数据完整性

### 5.1 数据保护

- ✅ **数据加密工具**：`EncryptionUtil`（`app/utils/encryption.py`）
  - 使用 Fernet 对称加密算法
  - 支持敏感数据加密/解密
  - 使用 PBKDF2HMAC 派生密钥（100000 次迭代）

### 5.2 数据清理

- ✅ **数据清理工具**：`DataSanitizer`（`app/utils/encryption.py`）
  - HTML 转义（防止 XSS）
  - 文件名清理（防止路径遍历）
  - SQL 安全验证

## 六、数据保密性

### 6.1 敏感信息保护

- ✅ **配置管理**：
  - 敏感配置（`SECRET_KEY`、`JWT_SECRET_KEY`）从环境变量读取
  - 生产环境必须使用强密钥
- ✅ **密码掩码**：`EncryptionUtil.mask_sensitive_data()` 用于日志记录时掩码敏感数据

### 6.2 传输安全

- ✅ **HTTPS 支持**：配置 `ENABLE_HTTPS` 选项（生产环境必须启用）
- ✅ **CORS 配置**：生产环境需要严格配置允许的源（`CORS_ORIGINS`）

## 七、软件容错

### 7.1 错误处理

- ✅ **统一错误响应**：`ResponseModel`（`app/core/response.py`）统一错误响应格式
- ✅ **异常处理**：
  - `HTTPException` 处理器
  - `RequestValidationError` 处理器
  - `ResponseValidationError` 处理器
  - 全局异常处理器（生产环境不泄露详细信息）

### 7.2 日志记录

- ✅ **错误日志**：所有异常都记录到应用日志
- ✅ **日志级别**：使用 `loguru` 进行分级日志记录

## 八、资源控制

### 8.1 资源限制

- ✅ **文件上传限制**：
  - 最大文件大小（`MAX_UPLOAD_SIZE`）
  - 允许的文件扩展名（`ALLOWED_EXTENSIONS`）
- ✅ **速率限制**：防止资源滥用

## 九、开发规范要求

### 9.1 代码规范

- ✅ **类型注解**：使用 Python 类型注解提高代码可读性和安全性
- ✅ **文档字符串**：所有函数和类都有详细的文档说明
- ✅ **模块化设计**：功能模块清晰分离

### 9.2 配置管理

- ✅ **环境变量**：敏感配置通过环境变量管理
- ✅ **配置验证**：使用 `pydantic-settings` 进行配置验证

## 十、实施建议

### 生产环境部署前检查清单

1. ✅ **修改默认密钥**：
   - 设置强 `SECRET_KEY`
   - 设置强 `JWT_SECRET_KEY`
   
2. ✅ **启用 HTTPS**：
   - 设置 `ENABLE_HTTPS=True`
   - 配置 SSL 证书

3. ✅ **配置 CORS**：
   - 设置 `CORS_ORIGINS` 为实际的前端域名
   - 不要使用通配符 `*`

4. ✅ **数据库安全**：
   - 使用强数据库密码
   - 限制数据库访问 IP

5. ✅ **日志管理**：
   - 配置日志轮转
   - 定期备份审计日志

6. ✅ **监控告警**：
   - 监控登录失败次数
   - 监控异常请求
   - 监控系统资源使用

## 十一、相关文件说明

### 核心安全模块

- `app/core/security.py` - 认证授权模块
- `app/core/middleware.py` - 安全中间件
- `app/core/audit.py` - 审计日志模块
- `app/core/config.py` - 配置管理（包含安全配置）
- `app/utils/encryption.py` - 加密工具
- `app/utils/password.py` - 密码验证工具

### 配置项说明

所有安全相关的配置都在 `app/core/config.py` 的 `Settings` 类中定义，包括：

- 密码策略配置（`PASSWORD_*`）
- 安全配置（`ENABLE_HTTPS`、`SESSION_TIMEOUT_MINUTES` 等）
- 速率限制配置（`RATE_LIMIT_*`）
- 审计日志配置（`AUDIT_LOG_*`）

## 十二、持续改进

系统应定期进行安全审计和评估，包括：

1. 定期审查审计日志
2. 定期更新依赖包
3. 定期进行安全测试
4. 根据新的安全威胁调整安全策略

---

**注意**：本系统架构已遵循等保 2.0 基本要求，但在实际部署时，还需要结合具体的网络安全设备和安全策略，确保整体安全防护体系的有效性。
