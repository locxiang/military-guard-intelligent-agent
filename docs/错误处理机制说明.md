# 错误处理机制说明

## 概述

本系统实现了统一的错误处理机制，确保 **100% 返回 JSON 格式的响应**，无论发生任何错误。

## 核心特性

1. **全局异常捕获**：所有异常都会被全局异常处理器捕获，确保返回 JSON 格式
2. **统一错误码**：使用 `errorCode` 字段，非 0 表示错误
3. **统一响应格式**：所有响应都遵循相同的 JSON 结构

## 响应格式

### 成功响应
```json
{
  "errorCode": 0,
  "message": "success",
  "data": {
    // 具体数据
  }
}
```

### 错误响应
```json
{
  "errorCode": 非0错误码,
  "message": "错误消息",
  "data": {
    // 可选的错误详情
  }
}
```

## 错误码定义

错误码定义在 `app/core/errors.py` 中的 `ErrorCode` 类：

- `0`: 成功
- `1-99`: 通用错误
- `100-199`: 认证相关错误
- `200-299`: 请求相关错误
- `300-399`: 资源相关错误
- `500-599`: 服务器错误
- `600-699`: 业务逻辑错误

## 使用方法

### 1. 成功响应

推荐使用 `ResponseModel.success()`：

```python
from app.core.response import ResponseModel

@router.get("/example")
async def example():
    return ResponseModel.success(
        data={"key": "value"},
        message="操作成功"
    )
```

### 2. 抛出异常

#### 使用自定义异常类（推荐）

```python
from app.core.errors import (
    BusinessException,
    AuthException,
    NotFoundException,
    ValidationException,
    ErrorCode
)

# 业务逻辑错误
if some_condition:
    raise BusinessException(
        message="业务处理失败",
        error_code=ErrorCode.OPERATION_FAILED,
        data={"detail": "具体错误信息"}
    )

# 资源不存在
if not resource:
    raise NotFoundException(message="档案不存在")

# 认证失败
if not authenticated:
    raise AuthException(message="用户名或密码错误")

# 参数验证失败
if invalid_param:
    raise ValidationException(
        message="参数验证失败",
        data={"errors": ["字段1不能为空", "字段2格式错误"]}
    )
```

#### 使用 HTTPException（会被自动转换）

```python
from fastapi import HTTPException, status

# 这种方式也会被全局异常处理器捕获并转换为 JSON
raise HTTPException(
    status_code=status.HTTP_404_NOT_FOUND,
    detail="资源不存在"
)
```

### 3. 错误响应

如果需要直接返回错误响应：

```python
from app.core.response import ResponseModel
from app.core.errors import ErrorCode

return ResponseModel.error(
    message="操作失败",
    error_code=ErrorCode.OPERATION_FAILED,
    status_code=400
)
```

## 全局异常处理器

系统在 `app/main.py` 中注册了以下全局异常处理器：

1. **AppException 处理器**：处理自定义应用异常
2. **HTTPException 处理器**：处理 HTTP 异常
3. **RequestValidationError 处理器**：处理请求参数验证错误
4. **ResponseValidationError 处理器**：处理响应数据验证错误
5. **Exception 处理器**：处理所有其他未捕获的异常（兜底）

**重要**：即使代码中发生未捕获的异常，也会被最后一个 `Exception` 处理器捕获，确保返回 JSON 格式。

## 中间件错误处理

中间件中的错误也会返回 JSON 格式：

- **RateLimitMiddleware**：速率限制触发时返回 JSON
- **InputSanitizationMiddleware**：检测到非法输入时返回 JSON

## 最佳实践

1. **优先使用自定义异常类**：使用 `BusinessException`、`NotFoundException` 等，而不是直接使用 `HTTPException`
2. **使用 ResponseModel**：成功响应使用 `ResponseModel.success()`，保持一致性
3. **提供有意义的错误消息**：错误消息应该清晰、可操作
4. **使用合适的错误码**：根据错误类型选择合适的错误码
5. **不要直接返回字典**：虽然可以工作，但使用 `ResponseModel` 更规范

## 示例

### 完整的 API 端点示例

```python
from fastapi import APIRouter, Depends
from app.core.response import ResponseModel
from app.core.errors import NotFoundException, BusinessException, ErrorCode
from app.core.security import oauth2_scheme

router = APIRouter()

@router.get("/resource/{resource_id}")
async def get_resource(
    resource_id: int,
    token: str = Depends(oauth2_scheme)
):
    try:
        # 业务逻辑
        resource = await get_resource_from_db(resource_id)
        
        if not resource:
            raise NotFoundException(
                message="资源不存在",
                data={"resource_id": resource_id}
            )
        
        # 返回成功响应
        return ResponseModel.success(
            data=resource.to_dict(),
            message="获取成功"
        )
    
    except BusinessException:
        # 业务异常会被自动捕获并返回 JSON
        raise
    
    except Exception as e:
        # 其他异常也会被全局异常处理器捕获
        raise BusinessException(
            message=f"处理失败: {str(e)}",
            error_code=ErrorCode.OPERATION_FAILED
        )
```

## 注意事项

1. **不要捕获所有异常后返回非 JSON**：让全局异常处理器处理
2. **生产环境**：生产环境中不会返回详细的错误堆栈信息
3. **开发环境**：开发环境会返回详细的错误信息，方便调试
4. **日志记录**：所有异常都会被记录到日志中

## 验证

可以通过以下方式验证错误处理机制：

1. 访问不存在的路由：应该返回 JSON 格式的 404 错误
2. 发送无效的请求参数：应该返回 JSON 格式的验证错误
3. 在代码中抛出异常：应该返回 JSON 格式的错误响应
4. 触发速率限制：应该返回 JSON 格式的 429 错误

所有情况下都应该返回统一的 JSON 格式，`errorCode` 非 0 表示错误。
