# 保卫核心业务智能体开发设计文档

## 一、文档概述

### 1.1 文档目的
本文档作为开发环境搭建、项目架构设计、开发规范制定的技术指南，为开发团队提供统一的开发标准与实施路径。

### 1.2 适用范围
适用于前端、后端、DevOps等所有开发人员，涵盖开发环境配置、项目结构、接口规范、部署流程等核心内容。

## 二、开发环境设计

### 2.1 技术栈选型

#### 2.1.1 前端技术栈
- **框架**: Vue 3.5+ (Composition API)
- **构建工具**: Vite 6.0+
- **语言**: TypeScript 5.6+
- **UI组件库**: Element Plus 2.8+
- **状态管理**: Pinia 2.2+
- **路由**: Vue Router 4.5+
- **样式**: Tailwind CSS 3.4+
- **可视化**: ECharts (待集成)
- **包管理**: pnpm

#### 2.1.2 后端技术栈
- **语言**: Python 3.11+
- **Web框架**: FastAPI 0.104+ (高性能、自动API文档)
- **异步框架**: Uvicorn (ASGI服务器)
- **ORM**: SQLAlchemy 2.0+ (支持异步)
- **数据库**: MySQL 8.0+
- **缓存**: Redis 7.0+ (会话管理、数据缓存)
- **AI框架**: PyTorch / TensorFlow (待集成)
- **OCR工具**: Tesseract OCR + OpenCV
- **中文分词**: jieba
- **包管理**: pip / poetry

#### 2.1.3 开发工具
- **容器化**: Docker + Docker Compose
- **数据库管理**: MySQL 8.0
- **版本控制**: Git
- **代码规范**: 
  - 前端: ESLint + Prettier
  - 后端: Black + Flake8 + mypy

### 2.2 开发环境架构

```
┌─────────────────────────────────────────────────────────┐
│                    Docker Compose                        │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   Frontend   │  │    Backend   │  │    MySQL     │  │
│  │   (Vite)     │  │  (FastAPI)   │  │   (8.0)      │  │
│  │              │  │              │  │              │  │
│  │  Port: 5173  │  │  Port: 8000  │  │  Port: 3306  │  │
│  │  Hot Reload  │  │  Hot Reload  │  │  Data: data/ │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

### 2.3 目录结构设计

```
military-guard-intelligent-agent/
├── frontend/                 # 前端项目
│   ├── src/
│   │   ├── api/              # API接口封装
│   │   ├── components/       # 公共组件
│   │   ├── views/            # 页面视图
│   │   ├── stores/           # Pinia状态管理
│   │   ├── router/           # 路由配置
│   │   ├── utils/            # 工具函数
│   │   ├── assets/           # 静态资源
│   │   └── styles/           # 样式文件
│   ├── public/               # 公共资源
│   ├── Dockerfile.dev        # 开发环境Dockerfile
│   └── package.json
│
├── backend/                  # 后端项目
│   ├── app/
│   │   ├── api/              # API路由
│   │   │   ├── v1/           # API版本1
│   │   │   │   ├── auth.py   # 认证相关
│   │   │   │   ├── archive.py # 档案管理
│   │   │   │   ├── doc_generate.py # 文档生成
│   │   │   │   └── knowledge_graph.py # 知识图谱
│   │   ├── core/             # 核心配置
│   │   │   ├── config.py     # 配置管理
│   │   │   ├── security.py   # 安全相关
│   │   │   └── database.py   # 数据库连接
│   │   ├── models/           # 数据模型
│   │   ├── schemas/          # Pydantic模型
│   │   ├── services/         # 业务逻辑层
│   │   │   ├── ocr_service.py    # OCR服务
│   │   │   ├── ai_service.py     # AI服务
│   │   │   └── doc_service.py    # 文档生成服务
│   │   ├── utils/            # 工具函数
│   │   └── main.py           # 应用入口
│   ├── requirements.txt      # Python依赖
│   ├── Dockerfile.dev        # 开发环境Dockerfile
│   └── .env.example          # 环境变量示例
│
├── data/                     # 数据存储目录
│   ├── mysql/                # MySQL数据文件
│   ├── redis/                # Redis数据文件（如需要）
│   ├── uploads/              # 上传文件存储
│   ├── backups/              # 备份文件
│   └── logs/                 # 日志文件
│
├── docker-compose.yml        # Docker Compose配置
├── .env                      # 环境变量（不提交到Git）
├── .gitignore
└── README.md
```

## 三、Docker开发环境配置

### 3.1 设计原则
1. **热更新支持**: 前端Vite、后端FastAPI均支持代码热更新，无需重启容器
2. **数据持久化**: 所有数据存储在`data/`目录，容器删除不影响数据
3. **开发友好**: 挂载源代码目录，实时同步代码变更
4. **网络隔离**: 服务间通过Docker网络通信，端口映射到宿主机

### 3.2 服务配置说明

#### 3.2.1 前端服务 (frontend)
- **基础镜像**: node:20-alpine
- **工作目录**: /app
- **端口映射**: 5173:5173
- **卷挂载**:
  - `./frontend:/app` (源代码)
  - `./frontend/node_modules:/app/node_modules` (依赖缓存)
- **命令**: `pnpm dev --host 0.0.0.0`
- **环境变量**: 
  - `VITE_API_BASE_URL=http://localhost:8000/api/v1`

#### 3.2.2 后端服务 (backend)
- **基础镜像**: python:3.11-slim
- **工作目录**: /app
- **端口映射**: 8000:8000
- **卷挂载**:
  - `./backend:/app` (源代码)
  - `./data/uploads:/app/uploads` (上传文件)
  - `./data/logs:/app/logs` (日志文件)
- **命令**: `uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`
- **环境变量**: 
  - `DATABASE_URL=mysql+pymysql://user:password@mysql:3306/military_guard`
  - `REDIS_URL=redis://redis:6379/0`

#### 3.2.3 MySQL服务 (mysql)
- **镜像**: mysql:8.0
- **端口映射**: 3306:3306
- **卷挂载**:
  - `./data/mysql:/var/lib/mysql` (数据持久化)
  - `./backend/scripts/init.sql:/docker-entrypoint-initdb.d/init.sql` (初始化脚本)
- **环境变量**:
  - `MYSQL_ROOT_PASSWORD=root_password`
  - `MYSQL_DATABASE=military_guard`
  - `MYSQL_USER=user`
  - `MYSQL_PASSWORD=password`

### 3.3 网络配置
- **网络名称**: military-guard-network
- **网络模式**: bridge
- **服务间通信**: 使用服务名称作为主机名（如：`http://backend:8000`）

## 四、开发规范

### 4.1 前端开发规范

#### 4.1.1 代码风格
- 使用TypeScript严格模式
- 组件使用Composition API
- 遵循Vue 3官方风格指南
- 使用ESLint + Prettier自动格式化

#### 4.1.2 文件命名
- 组件文件: PascalCase (如: `UserProfile.vue`)
- 工具文件: camelCase (如: `formatDate.ts`)
- 常量文件: UPPER_SNAKE_CASE (如: `API_CONSTANTS.ts`)

#### 4.1.3 API调用规范
- 统一使用`src/api/`目录下的封装函数
- 使用Axios或Fetch进行HTTP请求
- 统一错误处理机制
- 请求/响应数据使用TypeScript类型定义

#### 4.1.4 状态管理
- 使用Pinia进行状态管理
- Store按功能模块划分
- 避免在组件中直接操作API，统一通过Store

### 4.2 后端开发规范

#### 4.2.1 代码风格
- 遵循PEP 8规范
- 使用类型提示 (Type Hints)
- 使用Black进行代码格式化
- 使用mypy进行类型检查

#### 4.2.2 项目结构
- 遵循FastAPI项目结构规范
- API路由按版本划分 (`/api/v1/`)
- 业务逻辑放在`services/`目录
- 数据模型放在`models/`目录
- 使用Pydantic进行数据验证

#### 4.2.3 API设计规范
- 遵循RESTful API设计原则
- 统一响应格式:
```python
{
    "errorCode": 0,
    "message": "success",
    "data": {...}
}
```
- **分页接口返回格式**:
  分页接口采用更优雅的返回格式，将数据列表和分页信息分离：
```python
{
    "errorCode": 0,
    "message": "success",
    "data": [],  # 数据列表，直接为数组
    "page": {    # 分页信息，独立字段
        "total": 0,      # 总记录数
        "page": 1,       # 当前页码
        "pageSize": 20   # 每页数量（驼峰命名）
    }
}
```
  这种格式的优势：
  - `data` 字段直接为数组，前端可直接遍历使用
  - 分页信息独立在 `page` 字段，结构更清晰
  - 符合RESTful API设计最佳实践
- 使用HTTP状态码表示请求结果
- API版本通过URL路径控制 (`/api/v1/`)

#### 4.2.4 数据库规范
- 使用SQLAlchemy ORM 2.0+（支持异步操作）
- 数据库迁移使用Alembic进行版本管理
- 表名使用小写下划线命名
- 字段命名使用小写下划线
- 模型定义在`app/models/`目录下
- 所有模型必须继承自`app.core.database.Base`

### 4.3 Git提交规范
- 提交信息格式: `[类型] 简短描述`
- 类型: `feat`(新功能)、`fix`(修复)、`docs`(文档)、`style`(格式)、`refactor`(重构)、`test`(测试)、`chore`(构建)
- 示例: `[feat] 添加档案导入功能`

## 五、环境变量配置

### 5.1 前端环境变量
```env
# .env.development
VITE_API_BASE_URL=http://localhost:8000/api/v1
VITE_APP_TITLE=保卫核心业务智能体
```

### 5.2 后端环境变量
```env
# .env
# 数据库配置
DATABASE_URL=mysql+pymysql://user:password@mysql:3306/military_guard
MYSQL_HOST=mysql
MYSQL_PORT=3306
MYSQL_USER=user
MYSQL_PASSWORD=password
MYSQL_DATABASE=military_guard

# Redis配置
REDIS_URL=redis://redis:6379/0
REDIS_HOST=redis
REDIS_PORT=6379

# 应用配置
APP_NAME=保卫核心业务智能体
APP_ENV=development
DEBUG=True
SECRET_KEY=your-secret-key-here

# 文件上传配置
UPLOAD_DIR=./data/uploads
MAX_UPLOAD_SIZE=524288000  # 500MB

# JWT配置
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=30

# OCR配置
OCR_MODEL_PATH=./models/ocr
TESSERACT_LANG=chi_sim+eng

# 数据库迁移配置
AUTO_MIGRATE=False  # 是否在启动时自动运行迁移（开发环境会自动迁移，生产环境建议手动）
```

## 六、开发流程

### 6.1 环境启动流程
1. 确保已安装Docker和Docker Compose
2. 复制`.env.example`为`.env`并配置环境变量
3. 创建必要的目录: `mkdir -p data/{mysql,uploads,logs,backups}`
4. 启动服务: `docker-compose up -d`
5. 查看日志: `docker-compose logs -f [service_name]`

### 6.2 开发调试流程
1. **前端开发**:
   - 修改`frontend/src/`下的代码
   - Vite自动热更新，浏览器自动刷新
   - 查看控制台错误信息

2. **后端开发**:
   - 修改`backend/app/`下的代码
   - FastAPI自动重载，无需重启
   - 查看容器日志: `docker-compose logs -f backend`
   - 访问API文档: `http://localhost:8000/docs`

3. **数据库操作**:
   - 连接数据库: `docker-compose exec mysql mysql -u user -p military_guard`
   - 执行迁移: `docker-compose exec backend alembic upgrade head`
   - 生成迁移脚本: `docker-compose exec backend alembic revision --autogenerate -m "描述"`
   - 查看迁移状态: `docker-compose exec backend alembic current`
   - 查看迁移历史: `docker-compose exec backend alembic history`
   - 查看数据: `docker-compose exec mysql mysql -u user -p military_guard -e "SELECT * FROM table_name;"`

### 6.3 常见问题处理
1. **端口冲突**: 修改`docker-compose.yml`中的端口映射
2. **权限问题**: 确保`data/`目录有写权限
3. **依赖安装**: 
   - 前端: `docker-compose exec frontend pnpm install`
   - 后端: `docker-compose exec backend pip install -r requirements.txt`
4. **数据重置**: 删除`data/mysql/`目录并重启服务

## 七、API接口设计

### 7.1 接口基础路径
- 开发环境: `http://localhost:8000/api/v1`
- 生产环境: `https://your-domain.com/api/v1`

### 7.2 认证机制
- 使用JWT Token进行身份认证
- Token通过Header传递: `Authorization: Bearer <token>`
- Token过期时间: 30分钟

### 7.3 核心接口模块
1. **认证模块** (`/api/v1/auth`)
   - POST `/login` - 用户登录
   - POST `/logout` - 用户登出
   - POST `/refresh` - 刷新Token

2. **档案管理模块** (`/api/v1/archive`)
   - POST `/import` - 批量导入档案
   - GET `/list` - 获取档案列表
   - GET `/detail/{id}` - 获取档案详情
   - POST `/search` - 全文检索

3. **文档生成模块** (`/api/v1/doc-generate`)
   - POST `/generate` - 生成文档
   - GET `/templates` - 获取模板列表
   - GET `/status/{task_id}` - 查询生成状态

4. **知识图谱模块** (`/api/v1/knowledge-graph`)
   - GET `/query` - 查询知识图谱
   - POST `/entity` - 创建实体
   - GET `/relations` - 获取关联关系

## 八、数据库设计

### 8.1 核心表结构（初步设计）

#### 8.1.1 用户表 (users)
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    real_name VARCHAR(100),
    department VARCHAR(100),
    role VARCHAR(20) DEFAULT 'user',
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 8.1.2 档案表 (archives)
```sql
CREATE TABLE archives (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    archive_no VARCHAR(50) UNIQUE,
    title VARCHAR(500),
    archive_type VARCHAR(50),
    source_department VARCHAR(100),
    file_path VARCHAR(500),
    ocr_text TEXT,
    metadata JSON,
    tags JSON,
    status VARCHAR(20) DEFAULT 'pending',
    created_by BIGINT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_archive_no (archive_no),
    INDEX idx_type (archive_type),
    FULLTEXT idx_fulltext (title, ocr_text)
);
```

### 8.2 数据库迁移管理（Alembic）

#### 8.2.1 迁移工具说明
项目使用 **Alembic** 作为数据库迁移工具，支持根据代码模型自动生成迁移脚本，实现数据库表结构的自动创建和修正。

**核心特性：**
- ✅ 根据 SQLAlchemy 模型自动生成迁移脚本
- ✅ 支持表结构变更的自动检测（新增表、字段、索引等）
- ✅ 版本化管理，支持回滚
- ✅ 开发环境支持启动时自动迁移
- ✅ 生产环境可手动控制迁移时机

#### 8.2.2 基本使用流程

**1. 修改模型后生成迁移脚本**
```bash
# 进入后端目录
cd backend

# 自动生成迁移脚本（会根据模型变化自动检测）
alembic revision --autogenerate -m "描述信息"

# 示例
alembic revision --autogenerate -m "添加用户表"
alembic revision --autogenerate -m "添加档案表索引"
```

**2. 检查生成的迁移脚本**
生成的迁移脚本位于 `backend/alembic/versions/` 目录，文件名格式为：`<revision_id>_描述信息.py`

**重要：** 自动生成的脚本可能不完美，需要人工检查：
- 检查字段类型是否正确
- 检查索引、外键是否正确
- 检查默认值、约束是否正确
- 对于数据迁移，需要手动编写 SQL

**3. 应用迁移**
```bash
# 应用所有待执行的迁移
alembic upgrade head

# 应用到指定版本
alembic upgrade <revision_id>

# 升级到下一个版本
alembic upgrade +1
```

**4. 回滚迁移**
```bash
# 回滚到上一个版本
alembic downgrade -1

# 回滚到指定版本
alembic downgrade <revision_id>

# 回滚所有迁移（危险操作）
alembic downgrade base
```

**5. 查看迁移状态**
```bash
# 查看当前数据库版本
alembic current

# 查看迁移历史
alembic history

# 查看迁移历史（详细）
alembic history --verbose

# 查看待执行的迁移
alembic heads
```

#### 8.2.3 开发环境自动迁移

在开发环境中，应用启动时会自动检测并运行数据库迁移（如果 `APP_ENV=development`）。

**配置方式：**
- 开发环境：自动迁移（`APP_ENV=development`）
- 生产环境：需要手动运行迁移（`AUTO_MIGRATE=False`）

**手动控制：**
```bash
# 在 Docker 容器中运行迁移
docker-compose exec backend alembic upgrade head

# 或直接进入容器
docker-compose exec backend /bin/sh
alembic upgrade head
```

#### 8.2.4 模型定义规范

**1. 创建新模型**
```python
# app/models/example.py
from sqlalchemy import Column, BigInteger, String, DateTime, func
from app.core.database import Base

class Example(Base):
    __tablename__ = "examples"
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    name = Column(String(100), nullable=False)
    created_at = Column(DateTime, server_default=func.now())
```

**2. 导入模型**
```python
# app/models/__init__.py
from app.models.example import Example

__all__ = ["Example"]
```

**3. 生成迁移**
```bash
alembic revision --autogenerate -m "添加示例表"
```

#### 8.2.5 常见操作示例

**添加新字段：**
1. 在模型中添加字段
2. 运行 `alembic revision --autogenerate -m "添加xxx字段"`
3. 检查生成的脚本
4. 运行 `alembic upgrade head`

**修改字段类型：**
1. 在模型中修改字段类型
2. 运行 `alembic revision --autogenerate -m "修改xxx字段类型"`
3. **注意：** 可能需要手动编写数据迁移逻辑，避免数据丢失
4. 检查并修改生成的脚本
5. 运行 `alembic upgrade head`

**添加索引：**
1. 在模型中添加索引（使用 `Index` 或 `__table_args__`）
2. 运行 `alembic revision --autogenerate -m "添加xxx索引"`
3. 运行 `alembic upgrade head`

**删除表/字段：**
1. 从模型中删除表或字段
2. 运行 `alembic revision --autogenerate -m "删除xxx"`
3. **警告：** 删除操作会丢失数据，务必先备份
4. 检查生成的脚本
5. 运行 `alembic upgrade head`

#### 8.2.6 生产环境迁移注意事项

1. **备份数据库**：迁移前务必备份数据库
2. **测试迁移**：在测试环境先验证迁移脚本
3. **维护窗口**：在维护窗口期间执行迁移
4. **回滚准备**：准备好回滚方案
5. **监控**：迁移后监控应用运行状态

#### 8.2.7 迁移脚本目录结构

```
backend/
├── alembic/
│   ├── versions/          # 迁移脚本目录
│   │   ├── 001_initial.py
│   │   ├── 002_add_index.py
│   │   └── ...
│   ├── env.py            # Alembic 环境配置
│   ├── script.py.mako    # 迁移脚本模板
│   └── README            # 使用说明
├── alembic.ini           # Alembic 配置文件
└── app/
    └── models/           # SQLAlchemy 模型定义
```

### 8.3 数据库初始化（传统方式，已废弃）

> **注意：** 现在推荐使用 Alembic 进行数据库迁移，`init.sql` 仅作为参考。

- 初始化脚本位置: `backend/scripts/init.sql`
- 自动执行: Docker启动时自动执行（仅首次）
- **推荐：** 使用 Alembic 管理所有数据库变更

## 九、部署说明

### 9.1 开发环境部署
- 使用Docker Compose一键启动
- 支持热更新，适合日常开发

### 9.2 生产环境部署（后续）
- 使用Docker Compose或Kubernetes
- 配置Nginx反向代理
- 启用HTTPS
- 配置监控与日志收集

## 十、后续扩展

### 10.1 待集成服务
- Redis (缓存与会话管理)
- Neo4j (知识图谱数据库)
- MinIO (对象存储，用于大文件)
- Elasticsearch (全文检索增强)

### 10.2 待开发功能
- 用户权限管理系统
- 文件上传下载功能
- OCR识别服务
- AI文档生成服务
- 知识图谱构建服务

---

## 附录

### A. 常用命令

```bash
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 查看日志
docker-compose logs -f [service_name]

# 重启服务
docker-compose restart [service_name]

# 进入容器
docker-compose exec [service_name] /bin/sh

# 查看服务状态
docker-compose ps

# 构建镜像
docker-compose build [service_name]
```

### B. 开发工具推荐
- **IDE**: VS Code + 插件
  - Volar (Vue支持)
  - Python (Python支持)
  - Docker (Docker支持)
- **API测试**: Postman / Insomnia
- **数据库管理**: DBeaver / MySQL Workbench
