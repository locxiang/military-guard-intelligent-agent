# 数据库初始化说明

## 概述

本项目使用**智能分表初始化机制**来管理数据库。应用启动时会自动检查每个表的状态，并根据需要进行初始化。

## 初始化机制

### 核心原则

1. **数据持久化**：数据保存在 `./data/mysql` 目录，容器重启后数据保留
2. **分表检查**：每个表独立检查，只初始化空表
3. **自动结构同步**：检测表结构差异并自动执行 ALTER TABLE
4. **统一策略**：开发和生产环境使用相同策略

### 初始化流程

应用启动时自动执行以下流程：

```
应用启动
  ↓
检查数据库连接
  ↓
确保所有表存在（CREATE TABLE IF NOT EXISTS）
  ↓
分表检查（遍历所有表）
  ├─ users 表
  │   ├─ 为空 → 从 users.json 加载并插入数据
  │   └─ 不为空 → 跳过
  ├─ case_files 表
  │   ├─ 为空 → 从 case_files.json 加载并插入数据
  │   └─ 不为空 → 跳过
  ├─ import_tasks 表
  │   ├─ 为空 → 从 import_tasks.json 加载（通常为空数组）
  │   └─ 不为空 → 跳过
  ├─ doc_generate_tasks 表
  │   ├─ 为空 → 从 doc_generate_tasks.json 加载（通常为空数组）
  │   └─ 不为空 → 跳过
  └─ ocr_tasks 表
      ├─ 为空 → 从 ocr_tasks.json 加载（通常为空数组）
      └─ 不为空 → 跳过
  ↓
检查每个表的结构是否与模型一致
  ├─ 不一致 → 自动执行 ALTER TABLE 同步该表结构
  └─ 一致 → 继续
  ↓
启动完成
```

## 表初始化配置

| 表名 | JSON数据文件 | 说明 |
|------|------------|------|
| users | `users.json` | 包含默认管理员用户（admin/123123123） |
| case_files | `case_files.json` | 包含演示案卷数据（包含完整时间线） |
| import_tasks | `import_tasks.json` | 通常为空数组 |
| doc_generate_tasks | `doc_generate_tasks.json` | 通常为空数组 |
| ocr_tasks | `ocr_tasks.json` | 通常为空数组 |

## 表结构同步

### 自动同步内容

- ✅ 添加缺失的字段
- ✅ 修改字段类型（兼容的情况下）
- ✅ 修改字段可空性（NULL/NOT NULL）
- ✅ 添加缺失的索引

### 不自动处理的内容

- ❌ 删除字段（安全考虑，需手动处理）
- ❌ 不兼容的类型变更（需手动处理）
- ❌ 删除索引（需手动处理）

## 使用场景

### 场景1：首次启动

- 所有表都不存在 → 创建所有表
- 所有表都为空 → 初始化所有数据
- 表结构与模型一致 → 无需同步

### 场景2：已有数据

- 表已存在且有数据 → 跳过数据初始化
- 表结构不一致 → 自动同步结构

### 场景3：部分表有数据

- users 表有数据 → 跳过 users 初始化
- case_files 表为空 → 初始化 case_files 的 demo 数据
- 其他表为空 → 跳过（无初始数据）

### 场景4：表结构变更

- 添加了新字段 → 自动执行 ALTER TABLE ADD COLUMN
- 修改了字段类型 → 自动执行 ALTER TABLE MODIFY COLUMN
- 修改了字段可空性 → 自动执行 ALTER TABLE MODIFY COLUMN

## 手动重新初始化

如果需要重新初始化某个表的数据：

### 方法1：清空表数据后重启

```bash
# 清空特定表的数据
docker-compose exec mysql mysql -uroot -proot_password -e "USE military_guard; TRUNCATE TABLE case_files;"

# 重启后端服务（会自动检测到表为空并初始化）
docker-compose restart backend
```

### 方法2：手动创建表结构（通常不需要）

```bash
# 注意：表结构通过 SQLAlchemy 自动创建，通常不需要手动操作
# 如果需要手动创建，可以通过 Python 脚本：
# python -c "from app.core.database import init_db; import asyncio; asyncio.run(init_db())"

# 数据通过 JSON 文件自动初始化，无需手动导入
```

## 完全重新初始化

如果需要完全重新初始化数据库（清空所有数据）：

```bash
# 1. 停止 MySQL 容器
docker-compose stop mysql

# 2. 删除数据目录
rm -rf data/mysql/*

# 3. 重新启动 MySQL 容器
docker-compose up -d mysql

# 4. 等待初始化完成（约10-20秒）
sleep 15

# 5. 重启后端服务（会自动检测并初始化）
docker-compose restart backend
```

## 验证初始化

```bash
# 检查表是否存在
docker-compose exec mysql mysql -uroot -proot_password -e "USE military_guard; SHOW TABLES;"

# 检查数据数量
docker-compose exec mysql mysql -uroot -proot_password -e "USE military_guard; SELECT COUNT(*) as users FROM users; SELECT COUNT(*) as case_files FROM case_files;"

# 检查表结构
docker-compose exec mysql mysql -uroot -proot_password -e "USE military_guard; DESCRIBE case_files;" | grep timeline

# 查看后端日志
docker-compose logs backend | grep -E "初始化|同步|表"
```

## 日志说明

启动时会看到以下日志：

```
🔍 开始检查数据库初始化状态...
📋 检查表是否存在...
✅ 所有表已确保存在
📊 检查并初始化表数据...
表 users 为空，开始初始化...
✅ 已从 users.json 初始化表 users (1 条记录)
✅ 表 users 数据初始化完成
表 case_files 为空，开始初始化...
✅ 已从 case_files.json 初始化表 case_files (2 条记录)
✅ 表 case_files 数据初始化完成
🔄 检查并同步表结构...
表 users 结构已是最新
表 case_files 结构已是最新
✅ 数据库初始化检查完成
```

## 注意事项

1. **数据安全**：自动初始化只会在表为空时执行，不会覆盖已有数据
2. **结构同步**：表结构同步是安全的，只添加/修改字段，不删除字段
3. **性能影响**：启动时的检查很快，不会明显影响启动时间
4. **错误处理**：如果初始化失败，开发环境会继续启动，生产环境会阻止启动

## 故障排查

### 问题：表结构同步失败

**原因**：可能是不可兼容的类型变更

**解决**：查看日志，手动执行 ALTER TABLE 语句

### 问题：初始化数据未导入

**原因**：表不为空，跳过了初始化

**解决**：清空表数据后重启服务

### 问题：JSON 文件读取失败

**原因**：JSON 文件格式错误或路径不正确

**解决**：检查 JSON 文件格式，确保路径正确（`backend/scripts/data/`）
